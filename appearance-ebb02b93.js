define(["exports"],(function(e){"use strict";function t(e,t){let l=e[0],r=e[3],a=e[1],n=e[4],i=e[2],o=e[5],s=t[0],p=t[3],u=t[1],_=t[4],c=t[2],f=t[5];return e[0]=l*s+p*a,e[3]=s*r+p*n,e[1]=l*u+a*_,e[4]=r*u+n*_,e[2]=i+l*c+a*f,e[5]=r*c+o+n*f,e}function l(e,t){let l=t[0],r=t[3],a=t[1],n=t[4],i=t[2],o=t[5],s=e[0],p=e[3],u=e[1],_=e[4],c=e[2],f=e[5];return e[0]=l*s+p*a,e[3]=s*r+p*n,e[1]=l*u+a*_,e[4]=r*u+n*_,e[2]=i+l*c+a*f,e[5]=r*c+o+n*f,e}function r(e){let t=e[0],l=e[3],r=e[1],a=e[4],n=e[2],i=e[5],o=t*a-l*r;if(0!=o)return e[0]=a/o,e[3]=l/-o,e[1]=r/-o,e[4]=t/o,e[2]=(a*n-r*i)/-o,e[5]=(l*n-t*i)/o,e}function a(e=0,t=1,l=0){return t*l+e*(1-l)}function n(e,t){let r=e[0]*e[0]+e[3]*e[3],a=e[1]*e[1]+e[4]*e[4];if(a<1e-6||r<1e-6)return;let n=Math.sqrt(r),i=Math.sqrt(a),o=-1,s=0;if(e[0]/n>o&&(s=-e[3],o=e[0]/n),e[4]/i>o&&(s=e[1],o=e[4]/i),o>=.9999)return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],0;if(o<=-.9999)return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t[4]=e[4],t[5]=e[5],Math.PI;Math.abs(o)<1e-4&&(o=0);let p=Math.acos(o),u=Math.sqrt(1-o*o);return s<0&&(p=-p,u=-u),t[0]=e[0],t[1]=e[1],t[3]=e[3],t[4]=e[4],l(t,[o,-u,0,u,o,0]),t[2]=e[2],t[5]=e[5],p}var i;e.FilterType=void 0,(i=e.FilterType||(e.FilterType={}))[i.Blur=1]="Blur",i[i.Outline=2]="Outline",i[i.DropShadow=3]="DropShadow",i[i.MotionBlur=4]="MotionBlur",i[i.Wave=5]="Wave",i[i.Ripple=6]="Ripple",i[i.Alpha=7]="Alpha",i[i.Displace=8]="Displace",i[i.Color=9]="Color",i[i.RadialBlur=10]="RadialBlur",i[i.AngularBlur=11]="AngularBlur",i[i.Rays=12]="Rays",i[i.Layer=13]="Layer",i[i.Bloom=14]="Bloom",e.Appearance=void 0,function(e){const l=[];function a(e,t=-4){return(t<-50||t>50)&&(t=a(t)),(e<-50||e>50)&&(e=t+e+32767<<16>>16),e}function n(e){if(e.sorted_appearances)return e.sorted_appearances;let t=[],r=[];for(let l of e.underlays)l=i(e,l),a(l.plane,e.plane)!=a(e.plane)?r.push(l):t.push(...n(l));t.push(e);const o=e.overlays.filter((e=>e.layer>=0)),s=e.overlays.filter((e=>e.layer<0));o.sort(((e,t)=>e.layer-t.layer)),s.sort(((e,t)=>e.layer-t.layer));const p=o.concat(s);for(let l of p)l=i(e,l),a(l.plane,e.plane)!=a(e.plane)?r.push(l):t.push(...n(l));return e.sorted_appearances=t,e.floating_appearances=r.length?r:l,t}function i(e,l){let r=!1,n=()=>{r||(r=!0,l=Object.assign({},l))};var i;if(l.dir==e.dir||l.dir_override||(n(),l.dir=e.dir),(e.pixel_x||e.pixel_y||e.pixel_z||e.pixel_w&&!(8&l.appearance_flags))&&(n(),l.pixel_x+=e.pixel_x,l.pixel_y+=e.pixel_y,l.pixel_z+=e.pixel_z,l.pixel_w+=e.pixel_w),8&l.appearance_flags||1==(i=e.transform)[0]&&0==i[1]&&0==i[2]&&0==i[3]&&1==i[4]&&0==i[5]||(n(),l.transform=[...l.transform],t(l.transform,e.transform)),4278190080!=(4278190080&e.color_alpha)&&!(4&l.appearance_flags)){n();let t=Math.round((e.color_alpha>>>24)*(l.color_alpha>>>24)/255);l.color_alpha=16777215&l.color_alpha|t<<24}if(16777215!=(16777215&e.color_alpha)&&!(2&l.appearance_flags)){n();let t=4278190080&l.color_alpha;for(let r=0;r<24;r+=8){t|=Math.round((e.color_alpha>>>r&255)*(l.color_alpha>>>r&255)/255)<<r}l.color_alpha=t}return(l.plane<-50||l.plane>50)&&(n(),l.plane=a(l.plane,e.plane)),l}e.resolve_plane=a,e.is_lighting_plane=function(e){return(e<-50||e>50)&&(e%=100),e>=10&&e<=16},e.get_appearance_parts=n,e.overlay_inherit=i,e.get_display_boundary=function(e){var t,l,r,a,i,o;let s=1/0,p=-1/0,u=1/0,_=-1/0;for(let c of n(e)){let e=null!==(r=null===(l=null===(t=c.icon_state_dir)||void 0===t?void 0:t.atlas_node)||void 0===l?void 0:l.width)&&void 0!==r?r:32,n=null!==(o=null===(i=null===(a=c.icon_state_dir)||void 0===a?void 0:a.atlas_node)||void 0===i?void 0:i.height)&&void 0!==o?o:32;for(let t of[-.5,.5])for(let l of[-.5,.5]){let r=c.transform[0]*t*e+c.transform[1]*l*n+c.transform[2]+.5*e+c.pixel_x+c.pixel_w,a=c.transform[3]*t*e+c.transform[4]*l*n+c.transform[5]+.5*n+c.pixel_y+c.pixel_z;s=Math.min(s,r),p=Math.max(p,r),u=Math.min(u,a),_=Math.max(_,a)}}return s>p||u>_?{x:0,y:0,width:0,height:0}:{x:s,y:u,width:p-s,height:_-u}},e.check_appearance_click=function(e,t,l,a=!1){var i;let o=n(e);for(let n=o.length-1;n>=0;n--){let s=a?2:e.mouse_opacity;if(0==s)continue;let p=o[n],u=r([...p.transform]);if(!u)continue;let _=null===(i=p.icon_state_dir)||void 0===i?void 0:i.current_frame;if(!_&&s<=1)continue;let c=32,f=32;_&&(c=_.sprite_data.width,f=_.sprite_data.height);let d=t-c/2-p.pixel_x-p.pixel_w,h=l-f/2-p.pixel_y-p.pixel_z,x=d*u[0]+h*u[1]+u[2]+c/2,m=d*u[3]+h*u[4]+u[5]+f/2;if(!(x<0||m<0||x>=c||m>=f)&&!(s<=1&&_&&0==_.sprite_data.data[4*(Math.floor(f-m)*c+Math.floor(x))+3]))return!0}return!1},e.parse_screen_loc=function e(t,l=15,r=15,a=32,n=a){if(t.includes(" to ")){let[i,o]=t.split(" to ");null!=o||(o=i);let[s,p]=e(i,l,r,a,n)[0],[u,_]=e(o,l,r,a,n)[0],c=[];for(let e=p;e<=_;e++)for(let t=s;t<=u;t++)c.push([t,e]);return c}let[i,o]=t.split(",");null!=o||(o=i),(i.includes("NORTH")||i.includes("SOUTH")||i.includes("TOP")||i.includes("BOTTOM")||o.includes("EAST")||o.includes("WEST")||o.includes("LEFT")||o.includes("RIGHT"))&&([i,o]=[o,i]);let s=0,p=0;for(let e=0;e<2;e++){let t=e?o:i,u=0,_=0,c=0,f=0;for(;t[u]>="A"&&t[u]<="Z";)u++;let d=t.substring(0,u);t=t.substring(u),"CENTER"==d?_=.5:e&&d.startsWith("NORTH")?_=1:e&&d.startsWith("SOUTH")?_=0:!e&&d.endsWith("EAST")?_=1:!e&&d.endsWith("WEST")?_=0:e&&d.startsWith("TOP")?_=1:e&&d.startsWith("BOTTOM")?_=0:!e&&d.endsWith("RIGHT")?_=1:!e&&d.endsWith("LEFT")?_=0:c--;let[h,x]=t.split(":");h.startsWith("+")&&(h=h.substring(1)),h.endsWith("%")?_+=+h.substring(0,h.length-1)/100:c+=+h,x&&(f+=+x);let m=_*((e?r:l)-1)+c+f/(e?n:a);e?p=m:s=m}return[[s,p]]}}(e.Appearance||(e.Appearance={})),e.ReaderAppearance=void 0,(e.ReaderAppearance||(e.ReaderAppearance={})).base={icon:null,icon_state:null,name:null,appearance_flags:0,layer:2,plane:-32767,dir:2,color_alpha:-1,pixel_x:0,pixel_y:0,pixel_z:0,pixel_w:0,blend_mode:1,glide_size:8,screen_loc:null,transform:[1,0,0,0,1,0],invisibility:0,overlays:[],underlays:[],opacity:!1,density:!1,dir_override:!0,override:!1,color_matrix:null,maptext:null,mouse_opacity:1,animate_movement:1,filters:[],vis_flags:0},e.LONG_GLIDE=1,e.MAX_LAYER=32,e.SEE_MOBS=4,e.SEE_OBJS=8,e.SEE_THRU=512,e.SEE_TURFS=16,e.SOUND_MUTE=1,e.SOUND_PAUSED=2,e.SOUND_STREAM=4,e.SOUND_UPDATE=16,e.matrix_equals=function(e,t){return e[0]==t[0]&&e[1]==t[1]&&e[2]==t[2]&&e[3]==t[3]&&e[4]==t[4]&&e[5]==t[5]},e.matrix_interpolate=function e(t,r,i,o=!1){if(o)return[a(t[0],r[0],i),a(t[1],r[1],i),a(t[2],r[2],i),a(t[3],r[3],i),a(t[4],r[4],i),a(t[5],r[5],i)];let s=[0,0,0,0,0,0],p=[0,0,0,0,0,0],u=n(t,s),_=n(r,p);if(null==u||null==_)return e(t,r,i,!0);let c=_-u;if(c=((c+Math.PI)%(2*Math.PI)+2*Math.PI)%(2*Math.PI)-Math.PI,Math.abs(c)>=1e-4&&Math.abs(c)<Math.PI-1e-4){let e=u+i*c,t=[a(s[0],p[0],i),a(s[1],p[1],i),0,a(s[3],p[3],i),a(s[4],p[4],i),0],r=Math.cos(e),n=Math.sin(e);return l(t,[r,n,0,-n,r,0]),t[2]=a(s[2],p[2],i),t[5]=a(s[5],p[5],i),t}return e(t,r,i,!0)},e.matrix_invert=r,e.matrix_multiply=t,e.matrix_premultiply=l,e.matrix_translate=function(e,t=0,l=0){return e[2]+=t,e[5]+=l,e}}));
